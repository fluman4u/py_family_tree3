# 系统架构文档

## 1. 概述

族谱可视化系统是一个符合软件工程规范的族谱管理软件，采用 Python 开发，支持 CSV 数据维护、Web 可视化、行辈自动标注、迁徙时间轴分析等功能，并可打包为独立桌面应用。

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户界面层                                │
├──────────────────┬──────────────────┬───────────────────────────┤
│   命令行入口      │    Web 界面      │      桌面应用             │
│   (app.py)       │  (web/app.py)    │   (desktop/main.py)       │
└────────┬─────────┴────────┬─────────┴─────────────┬─────────────┘
         │                  │                       │
         └──────────────────┼───────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│                        业务逻辑层                                │
├─────────────┬─────────────┬─────────────┬───────────────────────┤
│  数据解析   │  数据校验   │  树构建     │  可视化生成            │
│ (parser)    │ (validate)  │ (tree)      │ (visualize)            │
├─────────────┼─────────────┼─────────────┼───────────────────────┤
│  过滤筛选   │  子树展开   │  行辈系统   │  迁徙分析              │
│ (filter)    │ (expand)    │ (lineage)   │ (migration)            │
└─────────────┴─────────────┴─────────────┴───────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│                        数据模型层                                │
├─────────────────────────────────────────────────────────────────┤
│                      Person 数据类                              │
│                    (src/model.py)                               │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│                        数据存储层                                │
├─────────────────────────────┬───────────────────────────────────┤
│     族谱数据 (CSV)           │      行辈配置 (YAML)              │
│   (data/family.csv)         │   (data/lineage.yaml)             │
└─────────────────────────────┴───────────────────────────────────┘
```

### 2.2 架构层次说明

| 层次    | 职责         | 模块/文件                               |
| ----- | ---------- | ----------------------------------- |
| 用户界面层 | 提供多种用户交互方式 | app.py, web/app.py, desktop/main.py |
| 业务逻辑层 | 核心业务处理     | src/*.py                            |
| 数据模型层 | 数据结构定义     | src/model.py                        |
| 数据存储层 | 数据持久化      | data/*.csv, data/*.yaml             |

## 3. 核心模块设计

### 3.1 数据流图

```
CSV 文件 ──→ Parser ──→ Dict[int, Person] ──→ Validator ──→ Tree Builder
                                                          │
                                                          ↓
                                            ┌─────────────┴─────────────┐
                                            │                           │
                                        Filter                     Migration
                                            │                       Analyzer
                                            ↓                           │
                                        Visualizer ←── Lineage ←────────┘
                                            │
                                            ↓
                                        HTML 输出
```

### 3.2 模块依赖关系

```
                    ┌─────────┐
                    │  model  │
                    └────┬────┘
                         │
         ┌───────┬───────┼───────┬───────┬───────┐
         │       │       │       │       │       │
         ↓       ↓       ↓       ↓       ↓       ↓
    ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
    │ parser │ │validate│ │  tree  │ │ filter │ │migration│
    └────────┘ └────────┘ └────────┘ └────┬───┘ └────────┘
                                           │
    ┌────────┐                             │
    │lineage │←────────────────────────────┤
    └────┬───┘                             │
         │                                 │
         ↓                                 ↓
    ┌──────────────────────────────────────────┐
    │               visualize                  │
    └──────────────────────────────────────────┘
```

## 4. 技术栈

### 4.1 核心依赖

| 库名          | 版本要求 | 用途         |
| ----------- | ---- | ---------- |
| pyvis       | -    | 网络图可视化     |
| networkx    | -    | 图数据结构支持    |
| flask       | -    | Web 框架     |
| pyyaml      | -    | YAML 配置解析  |
| pyinstaller | -    | 桌面应用打包     |
| selenium    | -    | 浏览器自动化（可选） |
| pillow      | -    | 图像处理（可选）   |

### 4.2 运行环境

- Python 3.8+
- 支持 Windows/Linux/macOS

## 5. 数据模型

### 5.1 Person 数据类

```python
@dataclass
class Person:
    id: int                      # 唯一标识符
    parent_id: Optional[int]     # 父节点 ID
    wbs: str                     # WBS 编码（层级结构编码）
    name: str                    # 姓名
    gender: Optional[str]        # 性别 (M/F)
    birth_year: Optional[int]    # 出生年份
    death_year: Optional[int]    # 逝世年份
    generation: Optional[int]    # 世代数
    clan_name: Optional[str]     # 氏族名称
    location: Optional[str]      # 居住地
    note: Optional[str]          # 备注
    children: List["Person"]     # 子节点列表
```

### 5.2 WBS 编码规则

WBS（Work Breakdown Structure）编码用于表示家族成员的层级关系：

```
1           # 第一代始祖
1.1         # 始祖的第一个孩子
1.2         # 始祖的第二个孩子
1.1.1       # 1.1 的第一个孩子
1.1.2       # 1.1 的第二个孩子
1.2.1       # 1.2 的第一个孩子
```

**编码规则**：

- 每个层级用 `.` 分隔
- 数字表示在该层级中的排序
- WBS 深度 = 世代数
- 父节点 WBS = 子节点 WBS 去掉最后一节

## 6. 功能模块详解

### 6.1 数据解析模块 (parser.py)

**职责**：读取 CSV 文件并转换为 Person 对象字典

**核心函数**：

- `read_family_csv(path: str) -> Dict[int, Person]`

**处理流程**：

1. 读取 CSV 文件（支持 UTF-8-BOM 编码）
2. 清洗数据（处理空值、NA、N/A 等）
3. 验证必填字段
4. 创建 Person 对象
5. 根据 WBS 推导 parent_id 关系

### 6.2 数据校验模块 (validate.py)

**职责**：验证族谱数据的完整性和一致性

**校验项**：

- WBS 唯一性校验
- 世代与 WBS 深度一致性校验
- 父子关系一致性校验

### 6.3 树构建模块 (tree.py)

**职责**：构建家族树结构

**核心函数**：

- `build_tree(persons: Dict[int, Person]) -> List[Person]`

**处理逻辑**：

- 遍历所有人员，根据 parent_id 建立父子关系
- 返回根节点列表（parent_id 为 None 的节点）

### 6.4 过滤筛选模块 (filter.py)

**职责**：根据条件筛选子树

**核心函数**：

- `filter_subtree(persons, root_id, root_wbs, max_depth, gen_min, gen_max)`

**筛选维度**：

- 指定根节点（ID 或 WBS）
- 最大展开深度
- 世代范围过滤

### 6.5 可视化模块 (visualize.py)

**职责**：生成交互式族谱图

**技术实现**：

- 使用 pyvis 库生成网络图
- 采用 hierarchical 布局算法
- 支持节点颜色区分世代
- 支持悬停显示详细信息

### 6.6 行辈系统模块 (lineage.py)

**职责**：管理行辈字系统

**核心功能**：

- 从 YAML 配置加载行辈诗
- 根据世代获取对应行辈字
- 为姓名添加行辈标注

### 6.7 迁徙分析模块 (migration.py)

**职责**：分析家族迁徙历史

**核心功能**：

- 按出生年份排序
- 生成迁徙时间轴
- 记录地点变化

## 7. 用户界面

### 7.1 命令行版本

**入口文件**：`app.py`

**使用方式**：

```bash
python app.py
```

**输出**：生成 `family.html` 文件

### 7.2 Web 版本

**入口文件**：`web/app.py`

**技术栈**：Flask

**功能特性**：

- 选择根节点
- 设置展开层数
- 实时生成族谱图
- 显示迁徙时间轴

**路由设计**：

| 路由  | 方法   | 功能         |
| --- | ---- | ---------- |
| `/` | GET  | 显示主页       |
| `/` | POST | 生成指定参数的族谱图 |

### 7.3 桌面应用

**入口文件**：`desktop/main.py`

**打包方式**：

```bash
pyinstaller --onefile desktop/main.py
```

**功能**：自动打开浏览器访问 Web 界面

## 8. 扩展性设计

### 8.1 数据源扩展

系统设计支持扩展其他数据源：

- 数据库存储（SQLite/MySQL）
- JSON/XML 格式支持
- REST API 数据获取

### 8.2 可视化扩展

可视化模块可扩展：

- 支持多种布局算法
- 自定义节点样式
- 导出为图片格式

### 8.3 功能扩展

预留扩展点：

- 家族事件记录
- 照片管理
- 家族故事/传记
- 多家族管理

## 9. 安全性考虑

### 9.1 数据安全

- CSV 文件为本地存储，无网络传输风险
- 敏感信息可通过备注字段加密存储

### 9.2 Web 安全

- Flask debug 模式仅用于开发环境
- 生产环境应关闭 debug 模式
- 建议添加身份验证机制

## 10. 性能考虑

### 10.1 数据规模

- 当前设计适合中小型家族（数千人）
- 大型家族建议使用数据库存储

### 10.2 渲染性能

- pyvis 使用浏览器渲染，性能取决于客户端
- 建议控制显示节点数量（< 500）
- 使用过滤功能减少渲染节点
