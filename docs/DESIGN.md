# 族谱可视化系统设计文档

## 1. 项目背景与目标

传统族谱以纸质和静态电子文档为主，难以维护、查询和可视化。本项目旨在构建一个基于 Python 的族谱可视化与分析系统，支持人工维护 CSV 数据、自动校验一致性、交互式可视化展示，并可打包为桌面应用。

## 2. 设计目标

- 人工可维护的数据格式（CSV）
- 严格一致性校验（WBS 编码、世代关系）
- 支持任意节点展开指定层数
- 交互式 Web 可视化（彩色、可拖拽）
- 行辈 / 字辈自动标注
- 地域迁徙时间轴分析
- 可扩展为桌面应用

## 3. 数据模型设计

### 3.1 CSV 数据规范

- 一人一行，便于人工编辑
- 人工维护 WBS 层级编码（如 1.2.3）
- parent_id 明确父系关系
- 支持空值、缺失字段

### 3.2 WBS 层级编码

- 始祖：1
- 子代：1.1, 1.2
- 孙代：1.1.1

WBS 是族谱的结构真相源，由人工维护，程序负责校验。

### 3.3 行辈系统

采用独立 YAML 配置文件定义行辈诗，通过世代自动映射，不强制写回原始数据，保持数据纯净。

## 4. 系统架构

```
src/
├── model.py      # Person 数据模型
├── parser.py     # CSV 解析
├── validate.py   # 一致性校验
├── tree.py       # 树结构构建
├── filter.py     # 子树裁剪与过滤
├── lineage.py    # 行辈推导
├── migration.py  # 迁徙时间轴
├── visualize.py  # Web 图谱渲染
└── generator.py  # 随机测试数据
```

## 5. 核心算法

### 5.1 子树展开

深度优先遍历，限制最大展开层数，支持按世代范围过滤。

### 5.2 行辈推导

generation → 行辈诗索引 → 名字标注

### 5.3 迁徙时间轴

以出生年 + 地域作为迁徙近似模型，按时间排序展示。

## 6. 可视化设计

- 世代配色（10 种颜色循环）
- 节点悬浮提示（姓名、WBS、世代、行辈、生卒、备注）
- 浏览器交互（拖拽、缩放）

## 7. 桌面化方案

采用 Flask + PyInstaller，封装为单文件桌面程序：

```bash
pyinstaller --onefile desktop/main.py
```

## 8. 可扩展性

- 双亲 / 婚姻支持（DAG 结构）
- 地图迁徙可视化（folium）
- 多族谱管理
- 自动生成族谱册（PDF）
